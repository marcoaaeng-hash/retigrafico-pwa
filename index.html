<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retigráfico de Roçada</title>
<link rel="manifest" href="manifest.webmanifest">
<style>
body {
  font-family: Arial, sans-serif;
  background: #f7f9fa;
  margin: 0;
  padding: 0;
  text-align: center;
}
.container {
  padding: 10px;
  max-width: 600px;
  margin: auto;
}
h2 {
  color: #222;
  margin-top: 10px;
}
input, select, button {
  margin: 5px;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
}
button {
  background: #007bff;
  color: white;
  border: none;
  cursor: pointer;
}
button:hover {
  background: #0056b3;
}
.table-container {
  overflow-x: auto;
  margin-top: 10px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: center;
}
th {
  background: #f0f0f0;
}
.status-btn {
  border-radius: 15px;
  padding: 4px 10px;
  border: none;
  color: white;
  font-weight: bold;
}
.bom { background: #8BC34A; }
.regular { background: #FFEB3B; color: #000; }
.critico { background: #F44336; }
footer {
  margin-top: 15px;
}
#heatmap div {
  display: inline-block;
  width: 24px;
  height: 24px;
  margin: 2px;
  border-radius: 3px;
  border: 1px solid #ccc;
}
#stats {
  margin-top: 15px;
  font-size: 14px;
}
</style>
</head>
<body>
<div class="container">
  <h2>Retigráfico de Roçada</h2>

  <div>
    <label>Rodovia / UF:</label>
    <input type="text" id="rodoviaUF" placeholder="Ex: BR 040/MG">
  </div>
  <div>
    <label>KM Inicial:</label>
    <input type="number" id="kmStart" value="423">
    <label>KM Final:</label>
    <input type="number" id="kmEnd" value="425">
  </div>

  <div>
    <label>Selecionar Sentidos:</label><br>
    <select id="sentidos" multiple size="5">
      <option value="Sul">Sul</option>
      <option value="Norte">Norte</option>
      <option value="Canteiro Central">Canteiro Central</option>
      <option value="Leste">Leste</option>
      <option value="Oeste">Oeste</option>
    </select>
  </div>

  <button onclick="gerarTabela()">Gerar tabela</button>
  <button onclick="marcarTudoBom()">Marcar tudo Bom</button>
  <button onclick="limparTudo()">Limpar Dados</button>

  <div id="tabelaContainer" class="table-container"></div>

  <div id="heatmapContainer">
    <h3>Retigráfico Automático</h3>
    <div id="heatmap"></div>
    <div id="stats"></div>
  </div>

  <footer>
    <button onclick="exportCSV()">Exportar CSV</button>
    <button onclick="exportXLSX()">Exportar XLSX</button>
  </footer>
</div>

<script>
let dados = {};

function gerarTabela() {
  const kmInicio = parseInt(document.getElementById('kmStart').value);
  const kmFim = parseInt(document.getElementById('kmEnd').value);
  const sentidosSel = Array.from(document.getElementById('sentidos').selectedOptions).map(o => o.value);
  const tabela = document.createElement('table');
  tabela.innerHTML = `<tr><th>KM</th><th>Sentido</th><th>Status</th><th>Observação</th></tr>`;
  dados = {};

  for (let km = kmInicio; km <= kmFim; km++) {
    sentidosSel.forEach(sentido => {
      const id = `${km}-${sentido}`;
      dados[id] = { status: '', observacao: '' };
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${km}</td>
        <td>${sentido}</td>
        <td>
          <button class="status-btn bom" onclick="setStatus('${id}',1)">Bom</button>
          <button class="status-btn regular" onclick="setStatus('${id}',2)">Regular</button>
          <button class="status-btn critico" onclick="setStatus('${id}',3)">Crítico</button>
        </td>
        <td><input type="text" placeholder="Observação" onchange="setObs('${id}', this.value)"></td>
      `;
      tabela.appendChild(tr);
    });
  }
  document.getElementById('tabelaContainer').innerHTML = '';
  document.getElementById('tabelaContainer').appendChild(tabela);
  gerarHeatmap();
}

function setStatus(id, status) {
  dados[id].status = status;
  gerarHeatmap();
}

function setObs(id, texto) {
  dados[id].observacao = texto;
}

function gerarHeatmap() {
  const heat = document.getElementById('heatmap');
  heat.innerHTML = '';
  const cores = {1:'#8BC34A', 2:'#FFEB3B', 3:'#F44336', '':'#ccc'};
  let contagem = {1:0,2:0,3:0,total:0};

  for (const [id, v] of Object.entries(dados)) {
    const div = document.createElement('div');
    div.style.background = cores[v.status];
    heat.appendChild(div);
    if(v.status){contagem[v.status]++; contagem.total++;}
  }

  const stats = document.getElementById('stats');
  stats.innerHTML = `
    <p>Bom: ${(contagem[1]/contagem.total*100||0).toFixed(1)}% | 
    Regular: ${(contagem[2]/contagem.total*100||0).toFixed(1)}% | 
    Crítico: ${(contagem[3]/contagem.total*100||0).toFixed(1)}%</p>
  `;
}

function marcarTudoBom() {
  Object.keys(dados).forEach(id => dados[id].status = 1);
  gerarHeatmap();
}

function limparTudo() {
  dados = {};
  document.getElementById('tabelaContainer').innerHTML = '';
  document.getElementById('heatmap').innerHTML = '';
  document.getElementById('stats').innerHTML = '';
  document.getElementById('rodoviaUF').value = '';
  document.getElementById('kmStart').value = '';
  document.getElementById('kmEnd').value = '';
}

function exportCSV(){
  let csv = "RodoviaUF,KM,Sentido,Status,Observação\n";
  for(const [id,v] of Object.entries(dados)){
    const [km,sentido]=id.split("-");
    csv += `${document.getElementById('rodoviaUF').value},${km},${sentido},${v.status},${v.observacao}\n`;
  }
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'retigrafico.csv';
  a.click();
}

function exportXLSX(){
  alert('Exportação XLSX será integrada na próxima versão.');
}
</script>
</body>
</html>
