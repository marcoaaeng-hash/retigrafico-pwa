
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Retigráfico de Roçada</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Retigráfico">
  <link rel="apple-touch-icon" href="icon-512.png">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --ok:#8BC34A; --mid:#FFEB3B; --bad:#F44336; --empty:#E0E0E0; --ink:#0f172a; --muted:#64748b; --brand:#0ea5e9; --bg:#f8fafc; --card:#ffffff; --radius:16px; }
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:var(--bg); color:var(--ink)}
    .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px}
    header h1{font-size:20px; margin:0}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:0 6px 24px rgba(2,6,23,.06); padding:16px;}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    label{font-size:14px; color:var(--muted)}
    input[type="number"], button{padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; font-size:14px;}
    input[type="number"]{background:#fff; width:100%}
    button{background:var(--brand); color:white; border:none; cursor:pointer}
    button.ghost{background:#fff; color:var(--brand); border:1px solid var(--brand)}
    .seg-btns{display:flex; gap:8px; flex-wrap:wrap}
    .seg-btns button{background:#fff; color:var(--ink); border:1px solid #e5e7eb}
    .seg-btns button.active{border-color:var(--brand); box-shadow:0 0 0 3px rgba(14,165,233,.15)}
    table{width:100%; border-collapse:separate; border-spacing:0 6px;}
    th, td{padding:10px 12px; text-align:left; vertical-align:middle}
    thead th{font-size:12px; color:#475569}
    tbody tr{background:#fff;}
    tbody td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
    tbody td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
    .status-btns{display:flex; gap:8px}
    .chip{padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; cursor:pointer; user-select:none}
    .chip.ok{background:color-mix(in oklab, var(--ok) 22%, white); border-color:var(--ok)}
    .chip.mid{background:color-mix(in oklab, var(--mid) 22%, white); border-color:var(--mid)}
    .chip.bad{background:color-mix(in oklab, var(--bad) 22%, white); border-color:var(--bad)}
    .chip.active{box-shadow: inset 0 0 0 2px #00000020}
    .mini{font-size:12px; color:#475569}
    .photo-thumb{width:52px; height:52px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb}
    .thumbs{display:flex; gap:6px; flex-wrap:wrap}
    .heat{overflow:auto;}
    .heat-grid{display:grid; gap:2px}
    .legend{display:flex; gap:12px; align-items:center; margin-top:10px; color:#475569}
    .legend .box{width:14px; height:14px; border-radius:3px; display:inline-block}
    .sticky-col{position:sticky; left:0; background:var(--bg); z-index:2; padding-right:6px}
    footer{color:#64748b; font-size:12px; margin:16px 0; text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Retigráfico de Roçada</h1>
      <div class="row">
        <button class="ghost" id="btnExportCSV">Exportar CSV</button>
        <button class="ghost" id="btnExportXLSX">Exportar XLSX</button>
        <button id="btnReset">Limpar</button>
      </div>
    </header>

    <section class="card">
      <div class="grid-2">
        <div>
          <label>Sentido/Seção</label>
          <div class="seg-btns" id="segmentButtons"></div>
        </div>
        <div class="row" style="align-items:flex-end">
          <div style="flex:1">
            <label>KM Inicial</label>
            <input type="number" id="kmStart" value="423" step="1" />
          </div>
          <div style="flex:1">
            <label>KM Final</label>
            <input type="number" id="kmEnd" value="432" step="1" />
          </div>
          <div>
            <button id="btnGerar">Gerar tabela</button>
          </div>
        </div>
      </div>
      <p class="mini">GPS é capturado automaticamente ao tirar a foto. Até 3 fotos por KM.</p>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h2 style="font-size:16px; margin:0">Coleta de campo</h2>
        <div class="row">
          <button class="ghost" id="btnMarcarOk">Marcar tudo Bom</button>
          <button class="ghost" id="btnMarcarVazio">Limpar</button>
        </div>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="min-width:64px">KM</th>
              <th>Status</th>
              <th>Foto</th>
              <th>Observação</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between; align-items:baseline">
        <h2 style="font-size:16px; margin:0">Retigráfico automático</h2>
        <span class="mini">1=Bom (verde), 2=Regular (amarelo), 3=Crítico (vermelho)</span>
      </div>
      <div class="heat" id="heat"></div>
      <div class="legend">
        <span><span class="box" style="background:var(--ok)"></span> 1 (Bom)</span>
        <span><span class="box" style="background:var(--mid)"></span> 2 (Regular)</span>
        <span><span class="box" style="background:var(--bad)"></span> 3 (Crítico)</span>
        <span><span class="box" style="background:var(--empty)"></span> Sem dado</span>
      </div>
    </section>

    <footer>PWA: Instale na Tela de Início e use offline.</footer>
  </div>

<script>
const SECOES = ["Norte", "Sul", "Canteiro Central", "Marginal"];
let state = { kmStart:423, kmEnd:432, secao:SECOES[0], data:{} };
const $ = s => document.querySelector(s);

function save(){ localStorage.setItem('retigrafico_v32', JSON.stringify(state)); }
function load(){ const raw = localStorage.getItem('retigrafico_v32'); if(raw){ try{ state=JSON.parse(raw);}catch(e){} } SECOES.forEach(s=> state.data[s] ||= {}); }

function renderSegmentButtons(){
  const box = $('#segmentButtons'); box.innerHTML='';
  SECOES.forEach(s=>{
    const b=document.createElement('button'); b.textContent=s;
    b.className='chip ' + (state.secao===s?'active':''); b.onclick=()=>{ state.secao=s; save(); renderAll(); };
    box.appendChild(b);
  });
}
function range(a,b){ const r=[]; const step=a<=b?1:-1; for(let i=a;i!==b+step;i+=step) r.push(i); return r; }
function ensure(secao, km){ state.data[secao] ||= {}; state.data[secao][km] ||= {status:null, obs:'', photos:[]}; }
function label(code){ return code===1?'Bom': code===2?'Regular': code===3?'Crítico':'—'; }
function cls(code){ return code===1?'ok': code===2?'mid': code===3?'bad':''; }

// Captura GPS no momento do clique e retorna {lat,lon,acc,ts}
function getCurrentGPS(){
  return new Promise((resolve)=>{
    if(!navigator.geolocation){ resolve(null); return; }
    navigator.geolocation.getCurrentPosition((pos)=>{
      const {latitude, longitude, accuracy} = pos.coords;
      resolve({lat:latitude, lon:longitude, acc:accuracy, ts:new Date().toISOString()});
    }, (_)=> resolve(null), {enableHighAccuracy:true, timeout:8000, maximumAge:0});
  });
}

// Desenha legenda na foto com data/hora, lat/lon e KM + seção
async function annotatePhoto(dataURL, meta){
  const img = new Image();
  const loaded = await new Promise(r=>{ img.onload=r; img.src=dataURL; });
  const maxW=1600, maxH=1600;
  let w=img.width, h=img.height;
  const ratio = Math.min(maxW/w, maxH/h, 1);
  w = Math.round(w*ratio); h = Math.round(h*ratio);
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const dt = new Date(meta.ts);
  const lines=[
    dt.toLocaleString('pt-BR'),
    meta.gps ? `${meta.gps.lat.toFixed(6)},${meta.gps.lon.toFixed(6)}` : 'GPS: —',
    `Km ${meta.km} ${meta.secao.toLowerCase()}`
  ];
  ctx.font = Math.max(18, Math.round(w*0.03)) + 'px system-ui, -apple-system, sans-serif';
  const pad = Math.round(w*0.02);
  const lineH = Math.round(w*0.045);
  const textW = Math.max(...lines.map(t=>ctx.measureText(t).width));
  const boxW = Math.min(w - pad*2, textW + pad*2);
  const boxH = lineH*lines.length + pad*2;
  const x = pad, y = h - boxH - pad;
  ctx.fillStyle = 'rgba(0,0,0,0.75)'; ctx.fillRect(x, y, boxW, boxH);
  ctx.fillStyle = '#fff';
  lines.forEach((t,i)=> ctx.fillText(t, x+pad, y+pad + lineH*(i+0.8)));
  return canvas.toDataURL('image/jpeg', 0.9);
}

async function handlePhotoInput(e, row, secao, km){
  const file = e.target.files[0]; if(!file) return;
  if((row.photos||[]).length >= 3){ alert('Limite de 3 fotos por KM. Exclua uma para adicionar outra.'); return; }
  const reader = new FileReader();
  reader.onload = async (ev)=>{
    const ts = new Date().toISOString();
    // GPS automático aqui
    const gps = await getCurrentGPS();
    const annotated = await annotatePhoto(ev.target.result, {gps, ts, km, secao});
    row.photos.push({data: annotated, ts, gps});
    save(); renderAll();
  };
  reader.readAsDataURL(file);
}

function renderTable(){
  const tbody = $('#tbody'); tbody.innerHTML='';
  const kms=range(state.kmStart, state.kmEnd);
  kms.forEach(km=>{
    ensure(state.secao, km); const row=state.data[state.secao][km];
    const tr=document.createElement('tr');
    const c1=document.createElement('td'); c1.textContent=km; c1.style.fontWeight='600'; tr.appendChild(c1);
    const c2=document.createElement('td');
    const g=document.createElement('div'); g.className='status-btns';
    [[1,'Bom'],[2,'Regular'],[3,'Crítico']].forEach(([code,txt])=>{
      const chip=document.createElement('div'); chip.className=`chip ${cls(code)} ${row.status===code?'active':''}`;
      chip.textContent=txt; chip.onclick=()=>{ row.status=(row.status===code?null:code); save(); renderAll(); };
      g.appendChild(chip);
    }); c2.appendChild(g); tr.appendChild(c2);
    const c3=document.createElement('td');
    const file=document.createElement('input'); file.type='file'; file.accept='image/*'; file.capture='environment';
    file.onchange = (e)=> handlePhotoInput(e, row, state.secao, km);
    const thumbs=document.createElement('div'); thumbs.className='thumbs';
    (row.photos||[]).forEach((p,idx)=>{ const im=document.createElement('img'); im.src=p.data; im.className='photo-thumb'; im.title=new Date(p.ts).toLocaleString('pt-BR'); im.onclick=()=>{ if(confirm('Remover foto?')){ row.photos.splice(idx,1); save(); renderAll(); } }; thumbs.appendChild(im); });
    c3.appendChild(file); c3.appendChild(thumbs); tr.appendChild(c3);
    const c4=document.createElement('td'); const inp=document.createElement('input'); inp.type='text'; inp.placeholder='Observação'; inp.value=row.obs||''; inp.style.width='100%'; inp.onchange=()=>{ row.obs=inp.value; save(); };
    c4.appendChild(inp); tr.appendChild(c4);
    tbody.appendChild(tr);
  });
}

function renderHeat(){ const root=$('#heat'); root.innerHTML=''; const kms=range(state.kmStart, state.kmEnd); const grid=document.createElement('div'); grid.className='heat-grid'; grid.style.gridTemplateColumns=`120px repeat(${kms.length}, 28px)`; const h0=document.createElement('div'); h0.className='sticky-col mini'; grid.appendChild(h0); kms.forEach(km=>{ const c=document.createElement('div'); c.className='mini'; c.style.textAlign='center'; c.textContent=km; grid.appendChild(c); }); SECOES.forEach(sec=>{ const lab=document.createElement('div'); lab.className='sticky-col'; lab.textContent=sec; grid.appendChild(lab); kms.forEach(km=>{ ensure(sec, km); const st=state.data[sec][km].status; const cell=document.createElement('div'); cell.title=`${sec} • km ${km} • ${label(st)}`; cell.style.width='28px'; cell.style.height='24px'; cell.style.borderRadius='4px'; cell.style.background= st===1?'var(--ok)': st===2?'var(--mid)': st===3?'var(--bad)':'var(--empty)'; grid.appendChild(cell); }); }); root.appendChild(grid); }
function renderAll(){ $('#kmStart').value=state.kmStart; $('#kmEnd').value=state.kmEnd; renderSegmentButtons(); renderTable(); renderHeat(); }

// Exportações
function rowsCSV(){
  const kms=range(state.kmStart, state.kmEnd);
  const rows=[["secao","km","status(1=Bom,2=Reg,3=Cri)","observacao","foto1","foto2","foto3"]];
  SECOES.forEach(s=>{
    kms.forEach(km=>{
      const r=(state.data[s]||{})[km] || {status:null, obs:'', photos:[]};
      const photos=(r.photos||[]).map(p=>p.data);
      rows.push([s, km, r.status||'', (r.obs||'').replaceAll('"','""'), photos[0]||'', photos[1]||'', photos[2]||'']);
    });
  });
  return rows;
}
function exportCSV(){ const rows=rowsCSV(); const csv = rows.map(r=> r.map(v=>`"${v}"`).join(',')).join('\n'); download(csv, 'retigrafico.csv'); }
function download(text, filename){ const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); }

function exportXLSX(){
  const ws1 = XLSX.utils.aoa_to_sheet(rowsCSV());
  const kms=range(state.kmStart, state.kmEnd);
  const header = [''].concat(kms.map(k=>String(k)));
  const data = [header];
  SECOES.forEach(s=>{
    const line=[s];
    kms.forEach(km=>{ const st=(state.data[s]||{})[km]?.status || ''; line.push(st); });
    data.push(line);
  });
  const ws2 = XLSX.utils.aoa_to_sheet(data);
  ws2['!cols'] = [{wch:14}].concat(kms.map(()=>({wch:5})));
  ws2['!rows'] = Array(SECOES.length+1).fill({hpx:22});
  const startRow = SECOES.length + 3;
  XLSX.utils.sheet_add_aoa(ws2, [['Legenda','','1','','2','','3'],['','', 'Bom','','Regular','','Crítico']], {origin:{r:startRow, c:0}});
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws1, 'Coleta');
  XLSX.utils.book_append_sheet(wb, ws2, 'Retigrafico');
  XLSX.writeFile(wb, 'retigrafico.xlsx');
}

function actions(){
  $('#btnGerar').onclick=()=>{ state.kmStart=parseInt($('#kmStart').value,10); state.kmEnd=parseInt($('#kmEnd').value,10); save(); renderAll(); };
  $('#btnMarcarOk').onclick=()=>{ range(state.kmStart,state.kmEnd).forEach(km=>{ ensure(state.secao,km); state.data[state.secao][km].status=1; }); save(); renderAll(); };
  $('#btnMarcarVazio').onclick=()=>{ range(state.kmStart,state.kmEnd).forEach(km=>{ ensure(state.secao,km); state.data[state.secao][km].status=null; state.data[state.secao][km].obs=''; state.data[state.secao][km].photos=[]; }); save(); renderAll(); };
  $('#btnExportCSV').onclick=exportCSV; $('#btnExportXLSX').onclick=exportXLSX;
  $('#btnReset').onclick=()=>{ if(confirm('Limpar todos os dados?')){ localStorage.removeItem('retigrafico_v32'); load(); renderAll(); } };
}

if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(() => {}); }); }

load(); actions(); renderAll();
</script>
</body>
</html>
