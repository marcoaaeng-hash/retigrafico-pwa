<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Retigráfico de Roçada</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Retigráfico">
  <link rel="apple-touch-icon" href="icon-512.png">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    :root{ --ok:#8BC34A; --mid:#FFEB3B; --bad:#F44336; --empty:#E0E0E0; --ink:#0f172a; --muted:#64748b; --brand:#0ea5e9; --bg:#f8fafc; --card:#ffffff; --radius:16px; }
    *{box-sizing:border-box}
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:var(--bg); color:var(--ink)}
    .wrap{max-width:1100px; margin:18px auto; padding:0 12px}
    header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px; flex-wrap:wrap}
    header h1{font-size:22px; margin:0}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:0 6px 24px rgba(2,6,23,.06); padding:14px;}
    .grid{display:grid; gap:10px}
    .g-3{grid-template-columns:repeat(3, 1fr)}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
    input[type="number"], input[type="text"], button{padding:12px 12px; border-radius:14px; border:1px solid #e5e7eb; font-size:16px; line-height:1.2}
    input[type="number"], input[type="text"]{background:#fff; width:100%}
    button{background:var(--brand); color:white; border:none; cursor:pointer; white-space:nowrap}
    button.ghost{background:#fff; color:var(--brand); border:1px solid var(--brand)}
    button.bad{background:#ef4444}
    button.warn{background:#f59e0b; color:#1f2937; border:1px solid #f59e0b;}
    @media (max-width:640px){
      .g-3{grid-template-columns:1fr}
      header{gap:6px}
      input[type="number"], input[type="text"]{font-size:18px}
    }
    table{width:100%; border-collapse:collapse;}
    th, td{padding:10px 10px; text-align:left; vertical-align:middle; border-bottom:1px solid #e5e7eb; font-size:14px}
    thead th{font-weight:700}
    .table-actions{display:flex; gap:8px; margin:-8px 0 10px 0; flex-wrap:wrap}
    .status-btns{display:flex; gap:8px}
    .chip{padding:6px 10px; border-radius:999px; border:2px solid transparent; cursor:pointer; user-select:none; font-weight:600; font-size:13px}
    .chip.ok{background:#e6f4d8; border-color:#8BC34A; color:#2a4913}
    .chip.mid{background:#fff9c4; border-color:#FFEB3B; color:#7a6b00}
    .chip.bad{background:#ffdad6; border-color:#F44336; color:#7a0000}
    .chip.active{box-shadow: inset 0 0 0 2px #00000020}
    .mini{font-size:12px; color:#475569}
    .photo-thumb{width:56px; height:56px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb; cursor:pointer}
    .thumbs{display:flex; gap:6px; flex-wrap:wrap}
    .heat{overflow:auto; margin-top:12px}
    .heat-grid{display:grid; gap:2px}
    .legend{display:flex; gap:12px; align-items:center; margin-top:10px; color:#475569; flex-wrap:wrap}
    .legend .box{width:14px; height:14px; border-radius:3px; display:inline-block}
    .sticky-col{position:sticky; left:0; background:var(--bg); z-index:2; padding-right:6px}
    footer{color:#64748b; font-size:12px; margin:16px 0; text-align:center}
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.85); display:flex; align-items:center; justify-content:center; z-index:50}
    .modal.hidden{display:none}
    .modal img{max-width:92vw; max-height:92vh; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .bar{height:10px; border-radius:6px; background:#e5e7eb; overflow:hidden; width:220px}
    .bar > span{display:block; height:100%}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Retigráfico de Roçada</h1>
      <div class="row">
        <button class="ghost" id="btnExportCSV">Exportar CSV</button>
        <button class="ghost" id="btnExportXLSX">Exportar XLSX</button>
        <button class="bad" id="btnReset">Limpar Dados</button>
      </div>
    </header>

    <section class="card">
      <div class="grid g-3">
        <div>
          <label>Rodovia / UF</label>
          <input type="text" id="rodoviaUF" placeholder="Ex.: BR-040/MG" />
        </div>
        <div>
          <label>KM Inicial</label>
          <input type="number" id="kmStart" value="423" step="1" />
        </div>
        <div>
          <label>KM Final</label>
          <input type="number" id="kmEnd" value="432" step="1" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnGerar">Gerar tabela</button>
        <span class="mini">Sentidos fixos: Sul, Canteiro Central, Norte</span>
      </div>
      <p class="mini" style="margin-top:6px">Toque na miniatura para ampliar; toque e segure para excluir. GPS é capturado automaticamente na hora da foto.</p>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:4px">
        <h2 style="font-size:16px; margin:0">Coleta de campo</h2>
        <div class="table-actions">
          <button class="warn" id="btnMarkAllGood">Marcar tudo Bom</button>
          <button class="bad" id="btnClearAll">Limpar</button>
        </div>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="min-width:64px">km</th>
              <th>Sentido</th>
              <th>Status</th>
              <th>Foto</th>
              <th>Observação</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between; align-items:baseline">
        <h2 style="font-size:16px; margin:0">Retigráfico automático</h2>
        <span class="mini">1=Bom (verde), 2=Regular (amarelo), 3=Crítico (vermelho)</span>
      </div>
      <div class="heat" id="heat"></div>
      <div id="stats" class="legend" style="margin-top:12px"></div>
      <div class="legend">
        <span><span class="box" style="background:#8BC34A"></span> 1 (Bom)</span>
        <span><span class="box" style="background:#FFEB3B"></span> 2 (Regular)</span>
        <span><span class="box" style="background:#F44336"></span> 3 (Crítico)</span>
        <span><span class="box" style="background:#E0E0E0"></span> Sem dado</span>
      </div>
    </section>

    <footer>PWA: Instale na Tela de Início e use offline.</footer>
  </div>

  <div id="photoModal" class="modal hidden"><img id="photoModalImg" alt="Foto" /></div>

<script>
const ALL_SECOES = ["Sul","Canteiro Central","Norte"];
let state = { kmStart:423, kmEnd:432, rodoviaUF:'', data:{} };
const $ = s => document.querySelector(s);

function save(){ localStorage.setItem('retigrafico_v36', JSON.stringify(state)); }
function load(){ const raw = localStorage.getItem('retigrafico_v36'); if(raw){ try{ state=JSON.parse(raw);}catch(e){} }
  if(!state.rodoviaUF) state.rodoviaUF='';
  ALL_SECOES.forEach(s=> state.data[s] ||= {});
}
function clearAll(){
  if(confirm('Apagar TODOS os dados (status, fotos, observações e retigráfico)?')){
    localStorage.removeItem('retigrafico_v36');
    load(); renderAll();
  }
}

function range(a,b){ const r=[]; const step=a<=b?1:-1; for(let i=a;i!==b+step;i+=step) r.push(i); return r; }
function ensure(secao, km){ state.data[secao] ||= {}; state.data[secao][km] ||= {status:null, obs:'', photos:[]}; }
function label(code){ return code===1?'Bom': code===2?'Regular': code===3?'Crítico':'—'; }
function cls(code){ return code===1?'ok': code===2?'mid': code===3?'bad':''; }

function getCurrentGPS(){
  return new Promise((resolve)=>{
    if(!navigator.geolocation){ resolve(null); return; }
    navigator.geolocation.getCurrentPosition((pos)=>{
      const {latitude, longitude, accuracy} = pos.coords;
      resolve({lat:latitude, lon:longitude, acc:accuracy, ts:new Date().toISOString()});
    }, (_)=> resolve(null), {enableHighAccuracy:true, timeout:8000, maximumAge:0});
  });
}

async function annotatePhoto(dataURL, meta){
  const img = new Image(); await new Promise(r=>{ img.onload=r; img.src=dataURL; });
  const maxW=1600, maxH=1600; let w=img.width, h=img.height; const ratio = Math.min(maxW/w, maxH/h, 1);
  w = Math.round(w*ratio); h = Math.round(h*ratio);
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
  const dt = new Date(meta.ts);
  const lines=[ dt.toLocaleString('pt-BR'), meta.gps ? `${meta.gps.lat.toFixed(6)},${meta.gps.lon.toFixed(6)}` : 'GPS: —', `Km ${meta.km} ${meta.secao.toLowerCase()}` ];
  ctx.font = Math.max(18, Math.round(w*0.03)) + 'px system-ui, -apple-system, sans-serif';
  const pad = Math.round(w*0.02), lineH = Math.round(w*0.045); const textW = Math.max(...lines.map(t=>ctx.measureText(t).width));
  const boxW = Math.min(w - pad*2, textW + pad*2), boxH = lineH*lines.length + pad*2, x = pad, y = h - boxH - pad;
  ctx.fillStyle = 'rgba(0,0,0,0.75)'; ctx.fillRect(x, y, boxW, boxH);
  ctx.fillStyle = '#fff'; lines.forEach((t,i)=> ctx.fillText(t, x+pad, y+pad + lineH*(i+0.8)));
  return canvas.toDataURL('image/jpeg', 0.9);
}

async function handlePhotoInput(e, row, secao, km){
  const file = e.target.files[0]; if(!file) return;
  if((row.photos||[]).length >= 3){ alert('Limite de 3 fotos por KM. Exclua uma para adicionar outra.'); return; }
  const reader = new FileReader();
  reader.onload = async (ev)=>{
    const ts = new Date().toISOString();
    const gps = await getCurrentGPS();
    const annotated = await annotatePhoto(ev.target.result, {gps, ts, km, secao});
    row.photos.push({data: annotated, ts, gps});
    save(); renderAll();
  };
  reader.readAsDataURL(file);
}

function openModal(src){ $('#photoModalImg').src = src; $('#photoModal').classList.remove('hidden'); }
function closeModal(){ $('#photoModal').classList.add('hidden'); }
document.getElementById('photoModal').onclick = closeModal;
function bindThumbInteractions(imgEl, onDelete){
  let timer=null, longPressed=false;
  const start = ()=>{ longPressed=false; timer=setTimeout(()=>{ longPressed=true; if(confirm('Excluir esta foto?')) onDelete(); }, 600); };
  const end = ()=>{ if(timer){ clearTimeout(timer); timer=null; if(!longPressed){ openModal(imgEl.src); } } };
  imgEl.addEventListener('mousedown', start); imgEl.addEventListener('touchstart', start);
  imgEl.addEventListener('mouseup', end); imgEl.addEventListener('mouseleave', end); imgEl.addEventListener('touchend', end); imgEl.addEventListener('touchcancel', end);
}

function renderTable(){
  const tbody = $('#tbody'); tbody.innerHTML='';
  const kms=range(state.kmStart, state.kmEnd);
  kms.forEach(km=>{
    const sentidos = ALL_SECOES.slice();
    sentidos.forEach((sec, idx)=>{
      ensure(sec, km); const row=state.data[sec][km];
      const tr=document.createElement('tr');
      if(idx===0){
        const kmtd=document.createElement('td'); kmtd.textContent=km; kmtd.rowSpan=sentidos.length; kmtd.style.fontWeight='600'; tr.appendChild(kmtd);
      }
      const sTd=document.createElement('td'); sTd.textContent=(sec=="Canteiro Central"?"CC":sec); tr.appendChild(sTd);
      const stTd=document.createElement('td'); const g=document.createElement('div'); g.className='status-btns';
      [[1,'Bom'],[2,'Regular'],[3,'Crítico']].forEach(([code,txt])=>{
        const chip=document.createElement('div'); chip.className=`chip ${cls(code)} ${row.status===code?'active':''}`;
        chip.textContent=txt; chip.onclick=()=>{ row.status=(row.status===code?null:code); save(); renderAll(); };
        g.appendChild(chip);
      }); stTd.appendChild(g); tr.appendChild(stTd);
      const ftTd=document.createElement('td'); const file=document.createElement('input'); file.type='file'; file.accept='image/*'; file.capture='environment';
      file.onchange = (e)=> handlePhotoInput(e, row, sec, km);
      const thumbs=document.createElement('div'); thumbs.className='thumbs';
      (row.photos||[]).forEach((p,idx)=>{ const im=document.createElement('img'); im.src=p.data; im.className='photo-thumb'; im.title=new Date(p.ts).toLocaleString('pt-BR'); bindThumbInteractions(im, ()=>{ row.photos.splice(idx,1); save(); renderAll(); }); thumbs.appendChild(im); });
      ftTd.appendChild(file); ftTd.appendChild(thumbs); tr.appendChild(ftTd);
      const obsTd=document.createElement('td'); const inp=document.createElement('input'); inp.type='text'; inp.value=row.obs||''; inp.style.width='100%'; inp.onchange=()=>{ row.obs=inp.value; save(); };
      obsTd.appendChild(inp); tr.appendChild(obsTd);
      tbody.appendChild(tr);
    });
  });
}

function renderHeat(){
  const root=$('#heat'); root.innerHTML='';
  const kms=range(state.kmStart, state.kmEnd);
  const grid=document.createElement('div'); grid.className='heat-grid'; grid.style.gridTemplateColumns=`120px repeat(${kms.length}, 28px)`;
  const h0=document.createElement('div'); h0.className='sticky-col mini'; grid.appendChild(h0);
  kms.forEach(km=>{ const c=document.createElement('div'); c.className='mini'; c.style.textAlign='center'; c.textContent=km; grid.appendChild(c); });
  ALL_SECOES.forEach(sec=>{
    const lab=document.createElement('div'); lab.className='sticky-col'; lab.textContent=sec; grid.appendChild(lab);
    kms.forEach(km=>{ ensure(sec, km); const st=state.data[sec][km].status; const cell=document.createElement('div'); cell.title=`${sec} • km ${km} • ${label(st)}`; cell.style.width='28px'; cell.style.height='24px'; cell.style.borderRadius='4px'; cell.style.background= st===1?'#8BC34A': st===2?'#FFEB3B': st===3?'#F44336':'#E0E0E0'; grid.appendChild(cell); });
  });
  root.appendChild(grid);
}

function computeStats(){
  const kms=range(state.kmStart, state.kmEnd);
  let total=0, b=0, m=0, c=0;
  ALL_SECOES.forEach(sec=>{
    kms.forEach(km=>{
      ensure(sec, km);
      const v=state.data[sec][km].status;
      if(v) total++;
      if(v===1) b++; else if(v===2) m++; else if(v===3) c++;
    });
  });
  return {total, b, m, c, pb: total?Math.round(b*100/total):0, pm: total?Math.round(m*100/total):0, pc: total?Math.round(c*100/total):0};
}
function renderStats(){
  const s=computeStats();
  const el=$('#stats'); el.innerHTML='';
  const make = (label,color,pct)=>{
    const wrap=document.createElement('div'); wrap.className='row'; wrap.style.alignItems='center';
    const tag=document.createElement('span'); tag.innerHTML = `<span class="box" style="background:${color}"></span> ${label}: <b>${pct}%</b>`;
    tag.style.minWidth='120px';
    const bar=document.createElement('div'); bar.className='bar'; const fill=document.createElement('span'); fill.style.background=color; fill.style.width=pct+'%'; bar.appendChild(fill);
    wrap.appendChild(tag); wrap.appendChild(bar); return wrap;
  };
  el.appendChild(make('Bom', '#8BC34A', s.pb));
  el.appendChild(make('Regular', '#FFEB3B', s.pm));
  el.appendChild(make('Crítico', '#F44336', s.pc));
}

function renderAll(){
  $('#kmStart').value=state.kmStart; $('#kmEnd').value=state.kmEnd; $('#rodoviaUF').value=state.rodoviaUF;
  renderTable(); renderHeat(); renderStats();
}

function rowsCSV(){
  const kms=range(state.kmStart, state.kmEnd);
  const rows=[["rodoviaUF","secao","km","status(1=Bom,2=Reg,3=Cri)","observacao","foto1","foto2","foto3"]];
  ALL_SECOES.forEach(s=>{
    kms.forEach(km=>{
      const r=(state.data[s]||{})[km] || {status:null, obs:'', photos:[]};
      const photos=(r.photos||[]).map(p=>p.data);
      rows.push([state.rodoviaUF, s, km, r.status||'', (r.obs||'').replace('"','""'), photos[0]||'', photos[1]||'', photos[2]||'']);
    });
  });
  return rows;
}
function exportCSV(){ const rows=rowsCSV(); const csv = rows.map(r=> r.map(v=>`"${v}"`).join(',')).join('\n'); download(csv, 'retigrafico.csv'); }
function download(text, filename){ const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); }

async function exportXLSX(){
  const GREEN='8BC34A', YELLOW='FFEB3B', RED='F44336', GRAY='E0E0E0';
  const wb = new ExcelJS.Workbook();
  const ws1 = wb.addWorksheet('Coleta');
  const ws2 = wb.addWorksheet('Retigrafico');

  const rows = rowsCSV();
  ws1.addRow(rows[0]);
  [14,12,8,12,30,16,16,16].forEach((w,i)=> ws1.getColumn(i+1).width = w);
  for(let i=1;i<rows.length;i++){
    const arr = rows[i];
    const row = ws1.addRow(arr);
    row.height = 72;
    for(let f=0; f<3; f++){
      const dataURL = arr[5+f];
      if(!dataURL) continue;
      const base64 = dataURL.includes(',') ? dataURL.split(',')[1] : dataURL;
      const imgId = wb.addImage({base64, extension:'jpeg'});
      const col = 6 + f;
      ws1.addImage(imgId, { tl:{col: col-1 + 0.1, row: row.number-1 + 0.2}, ext:{width:96, height:68} });
    }
  }

  const kms = range(state.kmStart, state.kmEnd);
  ws2.addRow(['Rodovia/UF', state.rodoviaUF]); ws2.addRow([]);
  ws2.addRow([''].concat(kms.map(k=>String(k))));
  ws2.getRow(3).height = 22;
  ws2.getColumn(1).width = 16;
  kms.forEach((_,i)=> ws2.getColumn(i+2).width = 5);

  ALL_SECOES.forEach((s)=>{
    const line = [s];
    kms.forEach(km=>{
      const st=(state.data[s]||{})[km]?.status || '';
      line.push(st);
    });
    ws2.addRow(line);
  });

  for (let r=4; r<=3+ALL_SECOES.length; r++){
    ws2.getRow(r).height = 22;
    for (let c=2; c<=1+kms.length; c++){
      const cell = ws2.getRow(r).getCell(c);
      const v = cell.value;
      let fillColor = GRAY, fontColor = 'FFFFFFFF';
      if(v===1){ fillColor=GREEN; fontColor=GREEN; }
      else if(v===2){ fillColor=YELLOW; fontColor=YELLOW; }
      else if(v===3){ fillColor=RED; fontColor=RED; }
      else { cell.value = ''; }
      cell.fill = { type:'pattern', pattern:'solid', fgColor:{argb:fillColor} };
      cell.font = { color:{argb:fontColor} };
      cell.alignment = { horizontal:'center', vertical:'middle' };
    }
  }

  const base = 3 + ALL_SECOES.length + 2;
  ws2.getCell(`A${base}`).value = 'Legenda';
  ws2.getCell(`C${base}`).value = '1'; ws2.getCell(`C${base}`).fill = {type:'pattern', pattern:'solid', fgColor:{argb:'8BC34A'}};
  ws2.getCell(`E${base}`).value = '2'; ws2.getCell(`E${base}`).fill = {type:'pattern', pattern:'solid', fgColor:{argb:'FFEB3B'}};
  ws2.getCell(`G${base}`).value = '3'; ws2.getCell(`G${base}`).fill = {type:'pattern', pattern:'solid', fgColor:{argb:'F44336'}};
  ws2.getCell(`C${base+1}`).value = 'Bom'; ws2.getCell(`E${base+1}`).value = 'Regular'; ws2.getCell(`G${base+1}`).value = 'Crítico';

  const buf = await wb.xlsx.writeBuffer();
  saveAs(new Blob([buf], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), 'retigrafico.xlsx');
}

function actions(){
  document.getElementById('btnGerar').onclick=()=>{ state.kmStart=parseInt(document.getElementById('kmStart').value,10); state.kmEnd=parseInt(document.getElementById('kmEnd').value,10); state.rodoviaUF=document.getElementById('rodoviaUF').value; save(); renderAll(); };
  document.getElementById('rodoviaUF').onchange=()=>{ state.rodoviaUF=document.getElementById('rodoviaUF').value; save(); };
  document.getElementById('btnExportCSV').onclick=exportCSV;
  document.getElementById('btnExportXLSX').onclick=exportXLSX;
  document.getElementById('btnReset').onclick=clearAll;
  document.getElementById('btnClearAll').onclick=clearAll;
  document.getElementById('btnMarkAllGood').onclick=()=>{
    const kms=range(state.kmStart, state.kmEnd);
    ALL_SECOES.forEach(s=> kms.forEach(km=>{ ensure(s,km); state.data[s][km].status=1; }));
    save(); renderAll();
  };
}

if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(() => {}); }); }
load(); actions(); renderAll();
</script>
</body>
</html>
